<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Transcript Insight</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #1e40af;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.8em;
            font-weight: 800;
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e40af 0%, #fbbf24 50%, #1e40af 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% 200%;
            letter-spacing: -0.02em;
            line-height: 1.2;
            white-space: nowrap;
        }

        .input-section {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1e40af;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #fbbf24;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #1e40af;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .btn {
            background: #fbbf24;
            color: #1e40af;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
        }

        .btn:hover {
            background: #f59e0b;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
        }

        .status.loading {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        .status.error {
            background: #fef2f2;
            color: #dc2626;
            border-left: 4px solid #ef4444;
        }

        .status.success {
            background: #f0fdf4;
            color: #16a34a;
            border-left: 4px solid #22c55e;
        }

        .result-section {
            margin-top: 30px;
            display: none;
        }

        .result-section h3 {
            color: #1e40af;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .result-content {
            background: #fffbeb;
            border: 2px solid #fbbf24;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            white-space: pre-wrap;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            color: #1e293b;
        }

        .download-btn {
            background: #1e40af;
            color: white;
            margin-top: 15px;
        }

        .download-btn:hover {
            background: #1e3a8a;
        }

        .api-key-section {
            background: #fffbeb;
            border: 2px solid #fbbf24;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .note {
            font-size: 14px;
            color: #92400e;
            margin-top: 10px;
            font-style: italic;
        }

        .note a {
            color: #1e40af;
            text-decoration: none;
        }

        .note a:hover {
            text-decoration: underline;
        }

        .debug-info {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .debug-info.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>YouTube Transcript Insight</h1>
        
        <div class="api-key-section" style="display: none;">
            <label for="apiKey">üîë Cl√© API Gemini (optionnelle) :</label>
            <input type="password" id="apiKey" placeholder="Laissez vide pour utiliser la cl√© par d√©faut..." />
            <div class="note">
                üí° <strong>Mode par d√©faut :</strong> Cl√© API int√©gr√©e - pr√™t √† utiliser !<br>
                üîß <strong>Mode personnel :</strong> Entrez votre propre cl√© depuis <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>
            </div>
        </div>

        <div class="input-section">
            <label for="youtubeUrl">üé• URL YouTube :</label>
            <input type="text" id="youtubeUrl" placeholder="https://www.youtube.com/watch?v=..." />
        </div>

        <div class="input-section">
            <label for="subtitles">üìù Sous-titres (optionnel - copiez depuis YouTube) :</label>
            <textarea id="subtitles" rows="8" placeholder="Collez ici les sous-titres de la vid√©o...

üí° Comment obtenir les sous-titres :
1. Allez sur YouTube
2. Cliquez sur 'CC' ou '‚öôÔ∏è' ‚Üí Sous-titres
3. Cliquez sur 'Ouvrir la transcription'
4. Copiez tout le texte et collez ici"></textarea>
        </div>

        <button class="btn" onclick="processVideo()">
            ‚ú® Analyser la vid√©o
        </button>

        <div id="status"></div>
        
        <div class="debug-info" id="debugInfo"></div>

        <div class="result-section" id="resultSection">
            <h3>üìã R√©sum√© et analyse :</h3>
            <div class="result-content" id="resultContent"></div>
            <button class="btn download-btn" onclick="downloadResult()">
                üì• T√©l√©charger le r√©sum√© (TXT)
            </button>
        </div>
    </div>

    <script>
        let analysisResult = '';
        let debugLogs = [];
        
        // Votre cl√© API par d√©faut (directement dans le code)
        const DEFAULT_API_KEY = 'AIzaSyCccIgov-nc_OiFQ0eXm4xnJpaWJ1rYsvE';

        function getApiKey() {
            // Utiliser directement la cl√© par d√©faut
            if (DEFAULT_API_KEY && DEFAULT_API_KEY.startsWith('AIzaSy')) {
                return DEFAULT_API_KEY;
            }
            return null;
        }

        async function generateTitle(analysisText) {
            try {
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-goog-api-key': DEFAULT_API_KEY
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `G√©n√®re un titre de fichier d√©taill√© et descriptif bas√© sur ce r√©sum√© d'analyse. Le titre doit √™tre informatif, sp√©cifique au contenu, et adapt√© pour un nom de fichier (sans caract√®res sp√©ciaux).

Exemple de format souhait√©: "Analyse_Marketing_Digital_Strategies_SEO_2025_Guide_Complet"

R√©sum√© √† analyser:
${analysisText.substring(0, 1000)}

R√©ponds uniquement avec le titre propos√©, sans explication.`
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.3,
                            maxOutputTokens: 100
                        }
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                        return data.candidates[0].content.parts[0].text.trim()
                            .replace(/[^a-zA-Z0-9_\-\s]/g, '') // Supprimer caract√®res sp√©ciaux
                            .replace(/\s+/g, '_') // Remplacer espaces par underscore
                            .substring(0, 80); // Limiter la longueur
                    }
                }
            } catch (error) {
                log('‚ö†Ô∏è Erreur g√©n√©ration titre: ' + error.message);
            }
            
            // Fallback: titre basique avec timestamp
            return `YouTube_Analysis_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}`;
        }

        function log(message) {
            debugLogs.push(`[${new Date().toLocaleTimeString()}] ${message}`);
            document.getElementById('debugInfo').textContent = debugLogs.join('\n');
            document.getElementById('debugInfo').classList.add('show');
            console.log(message);
        }

        function showStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function hideStatus() {
            document.getElementById('status').innerHTML = '';
        }

        function extractVideoId(url) {
            const regex = /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/;
            const match = url.match(regex);
            return match ? match[1] : null;
        }

        async function extractSubtitlesWithAPI(videoId) {
            log(`Tentative extraction pour vid√©o: ${videoId}`);
            
            // API 1: Transcript API directe
            try {
                log('Test API 1: YouTube Transcript API');
                const response = await fetch(`https://cors-anywhere.herokuapp.com/https://www.googleapis.com/youtube/v3/captions?part=snippet&videoId=${videoId}&key=AIzaSyB-riBkMr8PZVVPqOXw3Kd_4E8Qa8BjLj8`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('API 1 r√©ponse: ' + JSON.stringify(data).substring(0, 100));
                }
            } catch (e) {
                log('API 1 √©chou√©e: ' + e.message);
            }

            // API 2: Service externe
            try {
                log('Test API 2: Service externe');
                const response = await fetch(`https://api.freeapi.app/api/v1/public/youtube/transcript/${videoId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.data && data.data.transcript) {
                        log('‚úÖ API 2 succ√®s !');
                        return data.data.transcript;
                    }
                }
                log('API 2: Pas de donn√©es transcript');
            } catch (e) {
                log('API 2 √©chou√©e: ' + e.message);
            }

            // API 3: Alternative simple
            try {
                log('Test API 3: Alternative');
                const response = await fetch(`https://subtitles-for-youtube.p.rapidapi.com/subtitles/${videoId}.json`, {
                    headers: {
                        'X-RapidAPI-Key': 'demo', // Cl√© de d√©mo
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('API 3 r√©ponse: ' + JSON.stringify(data).substring(0, 100));
                }
            } catch (e) {
                log('API 3 √©chou√©e: ' + e.message);
            }

            // API 4: YouTube Data API v3 (sans cl√©)
            try {
                log('Test API 4: YouTube Data');
                const response = await fetch(`https://www.youtube.com/api/timedtext?v=${videoId}&lang=en&fmt=json3`);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.events) {
                        const transcript = data.events
                            .filter(event => event.segs)
                            .map(event => event.segs.map(seg => seg.utf8).join(''))
                            .join(' ');
                        
                        if (transcript.length > 50) {
                            log('‚úÖ API 4 succ√®s ! Sous-titres trouv√©s');
                            return transcript;
                        }
                    }
                }
                log('API 4: Pas de sous-titres disponibles');
            } catch (e) {
                log('API 4 √©chou√©e: ' + e.message);
            }

            log('‚ùå TOUTES LES API ONT √âCHOU√â');
            throw new Error('Impossible d\'extraire les sous-titres. La vid√©o n\'a peut-√™tre pas de sous-titres auto-g√©n√©r√©s.');
        }

        async function extractSubtitles(videoUrl) {
            showStatus('üîç Recherche des sous-titres...');
            
            const videoId = extractVideoId(videoUrl);
            if (!videoId) {
                throw new Error('ID vid√©o introuvable dans l\'URL');
            }

            log(`=== D√âBUT EXTRACTION ===`);
            log(`URL: ${videoUrl}`);
            log(`Video ID: ${videoId}`);

            try {
                // Tentative d'extraction avec APIs publiques
                const subtitles = await extractSubtitlesWithAPI(videoId);
                log(`‚úÖ Sous-titres extraits: ${subtitles.length} caract√®res`);
                return subtitles;
                
            } catch (error) {
                log(`‚ùå Extraction √©chou√©e: ${error.message}`);
                
                // Dernier recours: Indiquer √† l'utilisateur quoi faire
                showStatus('‚ùå Extraction impossible. Voir les logs ci-dessous.', 'error');
                
                throw new Error(`Impossible d'extraire les sous-titres automatiquement.

SOLUTIONS:
1. Utilisez une vid√©o avec sous-titres auto-g√©n√©r√©s activ√©s
2. Ou cr√©ez un serveur local avec yt-dlp
3. Ou utilisez l'extension Chrome "YouTube Transcript"

VID√âO TEST√âE: ${videoId}
TOUTES LES API ONT √âCHOU√â - Voir logs pour d√©tails`);
            }
        }

        async function analyzeWithGemini(subtitles, apiKey, videoUrl) {
            showStatus('ü§ñ Analyse avec Gemini...');
            
            const videoId = extractVideoId(videoUrl);
            
            const prompt = `Tu es un expert en analyse de video pour but de r√©action de report pdf afin de faire gagner d temps sans avoir √† regarder la video, mas ans perdre une seule information, dans le but de faire des fiches sur beaucoup de sujet uniquement trait√© sur YouTube : je veux l'exhaustivit√© des concepts , infos , exemples, anecdotes , d√©tails en une reponse , dans le style plus concis et compr√©hensible possible de la video enti√®re en une seul grande r√©ponse, fractionn√© si besoin. Adapte √† chque sujet comme un expert , livre pour le plus de point possible des techniques et r√©flexion pro avec exp√©rience , aussi th√©orique que pratique (ou d'infos contre v√©rifi√©s, ce genre de choses sans oublier le but principal qui est l'apprentissage et le perfectionnement du lecteur final dans tout els domaines au plus haut niveau. Garde un ton complet et concis durant tout le rapport pour etre le plus lisible et assimilable possible, tout est √©tant exhaustif dans la compl√©tude du domaine  ou sujet √©voqu√©., n'h√©site pas √† extrapoler sur le sujet en donnant tout les secrets concernant cette technique ou ce domaine de pens√©e, th√®me ou objet . Il faut aussi expliquer le contexte et r√©sum√© la video pour les non initi√© , la parie technique est tr√®s bien ( niveau d'expertise au maximum, mais p√©dagogie hautement conseill√©)

SOUS-TITRES √Ä ANALYSER:
${subtitles}`;

            try {
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-goog-api-key': apiKey
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.3,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 4096
                        }
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erreur API Gemini: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                    return data.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('R√©ponse invalide de Gemini');
                }
            } catch (error) {
                throw new Error(`Erreur analyse Gemini: ${error.message}`);
            }
        }

        async function processVideo() {
            const videoUrl = document.getElementById('youtubeUrl').value.trim();
            const manualSubtitles = document.getElementById('subtitles').value.trim();

            // Reset des logs
            debugLogs = [];
            document.getElementById('debugInfo').classList.remove('show');

            // V√©rifier la cl√© API par d√©faut
            const apiKey = getApiKey();
            if (!apiKey) {
                showStatus('‚ùå Cl√© API par d√©faut manquante - V√©rifiez le code source', 'error');
                log('‚ùå DEFAULT_API_KEY non configur√©e correctement');
                return;
            }

            log('üîë Utilisation cl√© API par d√©faut configur√©e');

            // Si sous-titres manuels fournis, pas besoin d'URL
            if (!manualSubtitles && !videoUrl) {
                showStatus('‚ùå URL YouTube OU sous-titres requis', 'error');
                return;
            }

            // Validation URL seulement si pas de sous-titres manuels
            let videoId = null;
            if (!manualSubtitles && videoUrl) {
                videoId = extractVideoId(videoUrl);
                if (!videoId) {
                    showStatus('‚ùå URL YouTube invalide', 'error');
                    return;
                }
            }

            const analyzeBtn = document.querySelector('.btn');
            analyzeBtn.disabled = true;

            try {
                let subtitles;

                // Priorit√© aux sous-titres manuels si fournis
                if (manualSubtitles && manualSubtitles.length > 50) {
                    log('‚úÖ Utilisation des sous-titres manuels fournis');
                    log(`Longueur: ${manualSubtitles.length} caract√®res`);
                    subtitles = manualSubtitles;
                    analyzeBtn.textContent = 'Analyse en cours...';
                } else if (videoUrl) {
                    log('Tentative extraction automatique...');
                    analyzeBtn.textContent = 'Extraction en cours...';
                    subtitles = await extractSubtitles(videoUrl);
                    analyzeBtn.textContent = 'Analyse en cours...';
                } else {
                    throw new Error('Veuillez fournir soit une URL YouTube, soit coller les sous-titres manuellement');
                }
                
                if (!subtitles || subtitles.trim().length < 20) {
                    throw new Error('Sous-titres trop courts (moins de 20 caract√®res)');
                }

                log(`Analyse de ${subtitles.length} caract√®res de sous-titres avec cl√© par d√©faut`);
                
                // Analyse avec Gemini
                analysisResult = await analyzeWithGemini(subtitles, apiKey, videoUrl);
                
                // Affichage
                document.getElementById('resultContent').textContent = analysisResult;
                document.getElementById('resultSection').style.display = 'block';
                
                showStatus('‚úÖ Analyse termin√©e !', 'success');
                log(`‚úÖ SUCC√àS - Analyse termin√©e`);
                
            } catch (error) {
                showStatus(`‚ùå ${error.message}`, 'error');
                log(`‚ùå ERREUR: ${error.message}`);
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Analyser la vid√©o';
            }
        }

        async function downloadResult() {
            if (!analysisResult) {
                showStatus('‚ùå Aucun r√©sultat √† t√©l√©charger', 'error');
                return;
            }

            showStatus('üéØ G√©n√©ration du titre de fichier...', 'loading');
            
            // G√©n√©rer un titre intelligent avec Gemini
            const generatedTitle = await generateTitle(analysisResult);
            const videoUrl = document.getElementById('youtubeUrl').value;
            const videoId = extractVideoId(videoUrl);
            
            const filename = `${generatedTitle}.txt`;
            log(`üìù Titre g√©n√©r√©: ${generatedTitle}`);
            
            const content = `=== YOUTUBE TRANSCRIPT INSIGHT ===
Analys√© le: ${new Date().toLocaleString('fr-FR')}
URL: ${videoUrl || 'Analyse manuelle'}
ID Vid√©o: ${videoId || 'N/A'}
==========================================

${analysisResult}

==========================================
G√©n√©r√© par YouTube Transcript Insight
Powered by Gemini AI
==========================================`;

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showStatus('üì• Fichier t√©l√©charg√© avec titre intelligent !', 'success');
            setTimeout(hideStatus, 3000);
        }

        // Test automatique au chargement
        window.addEventListener('load', function() {
            log('YouTube Transcript Insight - D√©marrage');
            
            // V√©rifier la cl√© par d√©faut directement
            if (DEFAULT_API_KEY && DEFAULT_API_KEY.startsWith('AIzaSy') && DEFAULT_API_KEY.length > 35) {
                showStatus('‚úÖ App pr√™te - Cl√© API par d√©faut active !', 'success');
                log(`‚úÖ Cl√© API par d√©faut d√©tect√©e: ${DEFAULT_API_KEY.substring(0, 12)}...${DEFAULT_API_KEY.slice(-6)}`);
                log('üéØ Vos amis peuvent utiliser l\'app sans configuration !');
            } else {
                showStatus('‚ùå Cl√© API par d√©faut invalide - V√©rifiez le code', 'error');
                log(`‚ùå Cl√© actuelle: "${DEFAULT_API_KEY}"`);
                log('‚ö†Ô∏è La cl√© doit commencer par "AIzaSy" et faire plus de 35 caract√®res');
            }
            
            setTimeout(hideStatus, 4000);
            log('üí° Laissez le champ vide pour utiliser la cl√© par d√©faut');
        });

        // Simplification - plus de test de cl√© personnelle
        document.getElementById('apiKey').style.display = 'none';
    </script>
</body>
</html>
